---
import "../styles/global.css"

import { ViewTransitions } from "astro:transitions";
import Header from "../components/appHeader.vue";
import Footer from "../components/appFooter.vue";
import CookieConsent from "../components/CookieConsent.vue";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Novameat</title>
    <ViewTransitions />
  </head>

  <body class="bg-white">
    <Header transition:persist client:load/>
    <slot />
    <Footer />
    <script>
      import { gsap } from "gsap";
      import Lenis from "lenis";
      import { ScrollTrigger } from "gsap/ScrollTrigger";
      import { initProductAnimations } from "../scripts/productAnimations.js";
      import { initScrollAnimation } from "../scripts/scrollAnimation.js";
      import { initTabsAnimation } from "../scripts/tabsAnimation.js";
      import { cardEffect } from "../scripts/cardEffect.js";
      import { orderButtonAnimation } from "../scripts/orderButton.js";
      import { headerProductSelector } from "../scripts/headerProductSelector.js";
      import { copiesAnimation } from "../scripts/copiesAnimation.js";


      gsap.registerPlugin(ScrollTrigger);

      function lenis() {
        const lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      });

      lenis.on("scroll", ScrollTrigger.update);
      lenis.scrollTo(0, { immediate: true });
      ScrollTrigger.refresh();
      ScrollTrigger.defaults({
        //   scroller: document,
      });
      lenis.resize();
      function raf(time: any) {
        lenis.raf(time);
        requestAnimationFrame(raf);
      }
      requestAnimationFrame(raf);
      }

      

      document.addEventListener("astro:before-preparation", () => {
        console.log("before prep");
      });

      document.addEventListener("astro:before-swap", () => {
        console.log("before swap");
      });

      // En la navegaciÃ³n interna
      document.addEventListener("astro:after-swap", () => {
        console.log("after swap");

        
        // mata triggers previos, por si acaso
        ScrollTrigger.getAll().forEach((t) => t.kill());
        lenis();
        setTimeout(() => {
         
          ScrollTrigger.refresh(true);
          console.log("refreshed");
        }, 100);
        initProductAnimations();
        initScrollAnimation();
        initTabsAnimation();
        cardEffect();
        orderButtonAnimation();
        headerProductSelector(); 
        copiesAnimation();
        
      });

      // En la carga inicial
      document.addEventListener("astro:page-load", () => {
        console.log("page loaded");
        
        // mata triggers previos, por si acaso
        ScrollTrigger.getAll().forEach((t) => t.kill());
        // refresca el ScrollTrigger tras crear
        lenis();
        setTimeout(() => {
          
          ScrollTrigger.refresh(true);
          console.log("refreshed");
        }, 100);
        initProductAnimations();
        initScrollAnimation();
        initTabsAnimation();
        cardEffect();
        orderButtonAnimation();
        headerProductSelector(); 
        copiesAnimation();
        
      });
    </script>
    <CookieConsent client:load/>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    /* height: 100%; */
  }
</style>

---
import "../styles/global.css"

import { ViewTransitions } from "astro:transitions";
import Header from "../components/appHeader.vue";
import Footer from "../components/appFooter.vue";
import CookieConsent from "../components/CookieConsent.vue";
import CircleSmall from "../components/circleSmall.vue";

const { colorLogo = "#eee9e3" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Novameat</title>
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Montagu+Slab:opsz,wght@16..144,100..700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    >
    <ViewTransitions />
  </head>

  <body class="bg-white">
    <Header transition:persist colorLogo={colorLogo} client:load/>

    <div class="loading z-50 bg-black w-full h-[100vh] absolute top-0 left-0 flex justify-center items-center">
      <CircleSmall class="w-1/6" color={colorLogo} client:load ></CircleSmall>
    </div>
    
    <div class="slot-container opacity-0">
      <slot />
    </div>
    <div class="slot-container opacity-0">
      <Footer />
    </div>
    
    <script>
      import { gsap } from "gsap";
      import Lenis from "lenis";
      import { ScrollTrigger } from "gsap/ScrollTrigger";
      import { initProductAnimations } from "../scripts/productAnimations.js";
      import { initTabsAnimation } from "../scripts/tabsAnimation.js";
      import { cardEffect } from "../scripts/cardEffect.js";
      import { orderButtonAnimation } from "../scripts/orderButton.js";
      import { headerProductSelector } from "../scripts/headerProductSelector.js";
      import { copiesAnimation } from "../scripts/copiesAnimation.js";


      gsap.registerPlugin(ScrollTrigger);

      function lenis() {
        const lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      });

      lenis.on("scroll", ScrollTrigger.update);
      lenis.scrollTo(0, { immediate: true });
      ScrollTrigger.refresh();
      ScrollTrigger.defaults({
        //   scroller: document,
      });
      lenis.resize();
      function raf(time: any) {
        lenis.raf(time);
        requestAnimationFrame(raf);
      }
      requestAnimationFrame(raf);
      }

      function outPage(){
        const page = document.querySelectorAll(".slot-container")
        gsap.to(page, {
          autoAlpha: 0,
          duration: .2,
        })
      }

      function inPage(){
        const page = document.querySelectorAll(".slot-container")
        const loading = document.querySelector(".loading")
        gsap.fromTo(page, {
          autoAlpha: 0,
        },{
          autoAlpha: 1,
          duration: .3,
        })
        gsap.fromTo(loading, {
          autoAlpha: 1,
        },{
          delay:.6,
          autoAlpha: 0,
          duration: .3,
        })
      }

      document.addEventListener("astro:before-preparation", () => {
        console.log("before prep");
        outPage()
      });

      document.addEventListener("astro:before-swap", () => {
        console.log("before swap");
       
      });

      // En la navegaciÃ³n interna
      document.addEventListener("astro:after-swap", () => {
        console.log("after swap");

        inPage()
        // mata triggers previos, por si acaso
        ScrollTrigger.getAll().forEach((t) => t.kill());
        lenis();
        setTimeout(() => {
         
          ScrollTrigger.refresh(true);
          console.log("refreshed");
        }, 100);
        initProductAnimations();
        initTabsAnimation();
        cardEffect();
        orderButtonAnimation();
        headerProductSelector(); 
        copiesAnimation();

        
      });

      // En la carga inicial
      document.addEventListener("astro:page-load", () => {
        console.log("page loaded");
        inPage();
        // mata triggers previos, por si acaso
        ScrollTrigger.getAll().forEach((t) => t.kill());
        // refresca el ScrollTrigger tras crear
        lenis();
        setTimeout(() => {
          
          ScrollTrigger.refresh(true);
          console.log("refreshed");
        }, 100);
        initProductAnimations();
        initTabsAnimation();
        cardEffect();
        orderButtonAnimation();
        headerProductSelector(); 
        copiesAnimation();

        
      });
    </script>
    <CookieConsent client:load/>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    /* height: 100%; */
  }
</style>
